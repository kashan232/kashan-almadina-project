@extends('admin_panel.layout.app')
<style>
    /* Professional Product Search Dropdown */
    .searchResults {
        position: absolute;
        z-index: 9999;
        width: 400px !important;
        max-width: 500px;
        max-height: 350px;
        overflow-y: auto;
        background: #ffffff;
        border: 1px solid #d1d5db;
        border-radius: 8px;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
        margin-top: 4px;
        left: 0;
    }

    .searchResults::-webkit-scrollbar {
        width: 8px;
    }

    .searchResults::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 4px;
    }

    .searchResults::-webkit-scrollbar-thumb {
        background: #888;
        border-radius: 4px;
    }

    .searchResults::-webkit-scrollbar-thumb:hover {
        background: #555;
    }

    .search-result-item {
        padding: 12px 16px;
        cursor: pointer;
        border-bottom: 1px solid #e5e7eb;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .search-result-item:last-child {
        border-bottom: none;
    }

    .search-result-item:hover {
        background: #f3f4f6;
    }

    .search-result-item.active {
        background: #3b82f6;
        color: white;
    }

    .search-result-item.active .product-brand,
    .search-result-item.active .product-price {
        color: rgba(255, 255, 255, 0.9);
    }

    .product-icon {
        width: 36px;
        height: 36px;
        background: #e0e7ff;
        border-radius: 6px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 18px;
        flex-shrink: 0;
    }

    .search-result-item.active .product-icon {
        background: rgba(255, 255, 255, 0.2);
    }

    .product-info {
        flex: 1;
        min-width: 0;
    }

    .product-name {
        font-weight: 600;
        font-size: 14px;
        color: #1f2937;
        margin-bottom: 2px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .search-result-item.active .product-name {
        color: white;
    }

    .product-brand {
        font-size: 12px;
        color: #6b7280;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .product-price {
        font-weight: 600;
        font-size: 14px;
        color: #059669;
        white-space: nowrap;
        flex-shrink: 0;
    }

    .search-loading {
        padding: 16px;
        text-align: center;
        color: #6b7280;
        font-size: 13px;
    }

    .search-no-results {
        padding: 20px;
        text-align: center;
        color: #9ca3af;
        font-size: 13px;
    }

    .productSearch {
        position: relative;
    }

    .productSearch.searching::after {
        content: '';
        position: absolute;
        right: 10px;
        top: 50%;
        transform: translateY(-50%);
        width: 16px;
        height: 16px;
        border: 2px solid #3b82f6;
        border-top-color: transparent;
        border-radius: 50%;
        animation: spin 0.6s linear infinite;
    }

    @keyframes spin {
        to { transform: translateY(-50%) rotate(360deg); }
    }

    th {
        font-weight: 500 !important;
    }

    /* Enhanced product search input */
    .productSearch:focus {
        border-color: #3b82f6 !important;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
</style>
@section('content')
<div class="main-content bg-white">
    <div class="main-content-inner">
        <div class="row">
            <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css"
                rel="stylesheet">

            <style>
                .table-scroll tbody {
                    display: block;
                    max-height: calc(60px * 5);
                    overflow-y: auto;
                }

                .table-scroll thead,
                .table-scroll tbody tr {
                    display: table;
                    width: 100%;
                    table-layout: fixed;
                }

                .table-scroll thead {
                    width: calc(100% - 1em);
                }

                .table-scroll .icon-col {
                    width: 51px;
                    min-width: 51px;
                    max-width: 40px;
                }

                .table-scroll {
                    max-height: none !important;
                    overflow-y: visible !important;
                }

                .disabled-row input {
                    background-color: #f8f9fa;
                    pointer-events: none;
                }
            </style>

            <body>
                <div class="body-wrapper">
                    <div class="bodywrapper__inner">
                        <div class="d-flex justify-content-between align-items-center mb-3 flex-nowrap overflow-auto">
                            <div class="flex-grow-1">
                                <h6 class="page-title ml-4">Edit Purchase</h6>
                                <span class="badge bg-primary ms-3" style="font-size:14px;">Invoice: {{ $purchase->invoice_no }}</span>
                            </div>


                            <!-- Right side buttons -->
                            <div class="d-flex mt-2 mb-2 align-items-center">
                                <!-- Add Purchase List button -->
                                <a href="{{ route('Purchase.home') }}" class="btn btn-sm btn-primary" title="View Purchase List">
                                    <i class="bi bi-list-check me-1"></i> Purchase List
                                </a>
                            </div>
                        </div>

                        <div class="row gy-3 ">
                            <div class="col-lg-12 col-md-12 mb-30 m-auto">
                                <div class="card">
                                    <div class="card-body  ml-2">

                                        @if (session('success'))
                                        <div class="alert alert-success alert-dismissible fade show"
                                            role="alert">
                                            <strong>Success!</strong> {{ session('success') }}
                                            <button type="button" class="btn-close" data-bs-dismiss="alert"
                                                aria-label="Close"></button>
                                        </div>
                                        @endif

                                        <form id="purchaseForm" action="{{ route('purchase.update', $purchase->id) }}" method="POST">
                                            @csrf
                                            @method('PUT')
                                            <table class="table table-bordered table-sm text-center align-middle">
                                                <thead class="table-light">
                                                    <tr>
                                                        <th>Current Date</th>
                                                        <th>DC Date</th>
                                                        <th>Type</th>
                                                        <th>Vendor</th>
                                                        <th cla>DC #</th>
                                                        <th>Warehouse</th>
                                                        <th>Bilty No</th>
                                                        <th>Remarks</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    <tr>
                                                        <td>
                                                            <input name="current_date" value="{{ old('current_date', $purchase->current_date ? \Carbon\Carbon::parse($purchase->current_date)->format('Y-m-d') : date('Y-m-d')) }}"
                                                                type="date" class="form-control form-control-sm" required>
                                                            @error('current_date')
                                                                <div class="alert alert-danger p-1 mt-1" style="font-size: 12px;">{{ $message }}</div>
                                                            @enderror
                                                        </td>
                                                        <td><input name="dc_date" value="{{ old('dc_date', $purchase->dc_date ? \Carbon\Carbon::parse($purchase->dc_date)->format('Y-m-d') : date('Y-m-d')) }}"
                                                                type="date" class="form-control form-control-sm">
                                                            @error('dc_date')
                                                                <div class="alert alert-danger p-1 mt-1" style="font-size: 12px;">{{ $message }}</div>
                                                            @enderror
                                                        </td>
                                                        <td>
                                                            <select name="vendor_type" class="form-control form-control-sm" id="vendor_type_select">
                                                                <option value="" {{ old('vendor_type') ? '' : 'selected' }} disabled>Select</option>

                                                                <option value="vendor" {{ old('vendor_type') == 'vendor' ? 'selected' : '' }}>Vendor</option>
                                                                <option value="customer" {{ old('vendor_type') == 'customer' ? 'selected' : '' }}>Customer</option>
                                                                <option value="walkin" {{ old('vendor_type') == 'walkin' ? 'selected' : '' }}>Walkin Customer</option>
                                                            </select>
                                                            @error('vendor_type')
                                                                <div class="alert alert-danger p-1 mt-1" style="font-size: 12px;">{{ $message }}</div>
                                                            @enderror
                                                        </td>

                                                        <td>
                                                            <select name="vendor_id" class="form-control form-control-sm" style="width:105px;">
                                                                <option value="" disabled {{ old('vendor_id') ? '' : 'selected' }}>Select</option>
                                                            </select>
                                                            @error('vendor_id')
                                                                <div class="alert alert-danger p-1 mt-1" style="font-size: 12px;">{{ $message }}</div>
                                                            @enderror
                                                        </td>
                                                        <td><input name="dc" type="text" value="{{ old('dc', $purchase->dc) }}"
                                                                class="form-control form-control-sm" style="width:90px;">
                                                            @error('dc')
                                                                <div class="alert alert-danger p-1 mt-1" style="font-size: 12px;">{{ $message }}</div>
                                                            @enderror
                                                        </td>
                                                        <td>
                                                            <select name="warehouse_id" class="form-control form-control-sm">
                                                                <option value="" disabled {{ old('warehouse_id') ? '' : 'selected' }}>Select</option>
                                                                @foreach ($Warehouse as $ware)
                                                                <option value="{{ $ware->id }}" {{ (string)old('warehouse_id') === (string)$ware->id ? 'selected' : '' }}>
                                                                    {{ $ware->warehouse_name }}
                                                                </option>
                                                                @endforeach
                                                            </select>
                                                            @error('warehouse_id')
                                                                <div class="alert alert-danger p-1 mt-1" style="font-size: 12px;">{{ $message }}</div>
                                                            @enderror
                                                        </td>
                                                        <td>
                                                            <input name="bilty_no" type="text" value="{{ old('bilty_no', $purchase->bilty_no) }}"
                                                                class="form-control form-control-sm" style="width:90px;">
                                                            @error('bilty_no')
                                                                <div class="alert alert-danger p-1 mt-1" style="font-size: 12px;">{{ $message }}</div>
                                                            @enderror
                                                        </td>
                                                        <td><input name="remarks" type="text" value="{{ old('remarks', $purchase->note) }}" class="form-control form-control-sm">
                                                            @error('remarks')
                                                                <div class="alert alert-danger p-1 mt-1" style="font-size: 12px;">{{ $message }}</div>
                                                            @enderror
                                                        </td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                            <table
                                                class="table table-bordered table-sm text-center align-middle mt-2">
                                                <thead class="table-light">
                                                    <tr>
                                                        <th>Product</th>
                                                        <th>Brand</th>
                                                        <th>Price</th>
                                                        <th>Retail Price</th> <!-- ✅ New column -->
                                                        <th>Disc</th>
                                                        <th>Qty</th>
                                                        <th>Amount</th>
                                                        <th>Total</th>
                                                        <th>X</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="purchaseItems">
                                                    <tr>
                                                        <td>
                                                            <input type="hidden" name="product_id[]" class="product_id">
                                                            <input type="hidden" name="product_name[]" class="product_name_hidden">
                                                            <input type="text" class="form-control form-control-sm productSearch" placeholder="Search product..." autocomplete="off">
                                                            <div class="searchResults"></div>
                                                        </td>

                                                        <td class="uom border">
                                                            <input type="text" name="brand[]" class="form-control form-control-sm" readonly>
                                                        </td>
                                                        <td><input type="number" step="0.01" name="price[]" class="form-control form-control-sm price"></td>
                                                        <td>
                                                            <input type="text" name="retail_price_show[]" class="form-control form-control-sm retail_price_show" readonly>
                                                        </td>
                                                        <td>
                                                            <div class="input-group">
                                                                <input type="number" step="0.01" min="0" name="item_disc[]" class="form-control form-control-sm item_disc" placeholder="%">
                                                                <input type="text" name="item_disc_amount[]" class="form-control form-control-sm disc_amount" readonly placeholder="Disc Amt">
                                                            </div>
                                                            <input type="hidden" name="purchase_retail_price[]" class="purchase_retail_price">
                                                            <input type="hidden" name="purchase_net_amount[]" class="purchase_net_amount">
                                                        </td>
                                                        <td>
                                                            <input type="number" name="qty[]" class="form-control form-control-sm quantity" value="" min="1">
                                                        </td>
                                                        <td>
                                                            <input type="text" name="amount[]" class="form-control form-control-sm row-amount" readonly> <!-- ✅ New -->
                                                        </td>
                                                        <td>
                                                            <input type="text" name="total[]" class="form-control form-control-sm row-total" readonly>
                                                        </td>
                                                        <td><button type="button" class="btn btn-sm btn-danger remove-row">X</button></td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                            <div class="row mt-2">
                                                <!-- Accounts Allocation -->
                                                <div class="col-md-6">
                                                    <div class="card h-100">

                                                        <div class="card-header p-2 bg-light fw-bold d-flex justify-content-between align-items-center">
                                                            <span>Accounts Allocation</span>
                                                            <button type="button" id="addAccountRow" class="btn btn-sm btn-primary">
                                                                + Add
                                                            </button>
                                                        </div>

                                                        <div class="card-body p-2">
                                                            <table class="table table-bordered table-sm text-center align-middle" id="accountsTable">
                                                                <thead class="table-light">
                                                                    <tr>
                                                                        <th>Account Head</th>
                                                                        <th>Account</th>
                                                                        <th>Amount</th>
                                                                        <th>X</th>
                                                                    </tr>
                                                                </thead>
                                                                <tbody>
                                                                    <tr>
                                                                        <td>
                                                                            <select name="account_head_id[]" class="form-control form-control-sm accountHead">
                                                                                <option value="" disabled selected>Select Head</option>
                                                                                @foreach ($AccountHeads as $head)
                                                                                <option value="{{ $head->id }}">{{ $head->name }}</option>
                                                                                @endforeach
                                                                            </select>
                                                                        </td>
                                                                        <td>
                                                                            <select name="account_id[]" class="form-control form-control-sm accountSub" disabled>
                                                                                <option value="" disabled selected>Select Account</option>
                                                                            </select>
                                                                        </td>
                                                                        <td>
                                                                            <input type="number" step="0.01" name="account_amount[]" class="form-control form-control-sm accountAmount" value="0" disabled>
                                                                        </td>
                                                                        <td>
                                                                            <button type="button" class="btn btn-sm btn-danger removeAccountRow">X</button>
                                                                        </td>
                                                                    </tr>
                                                                </tbody>
                                                            </table>

                                                            <div class="mt-2 text-end">
                                                                <label class="fw-bold">Accounts Total:</label>
                                                                <input type="text" id="accountsTotal" class="form-control form-control-sm d-inline-block w-auto fw-bold" value="0" readonly>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>

                                                <!-- Totals -->
                                                <div class="col-md-6">
                                                    <div class="card h-100">
                                                        <div class="card-header p-2 bg-light fw-bold">Totals</div>
                                                        <div class="card-body p-2">
                                                            <table class="table table-bordered table-sm text-center align-middle mb-0">
                                                                <tr>
                                                                    <th>Subtotal</th>
                                                                    <td><input type="text" id="subtotal" name="subtotal" class="form-control form-control-sm" value="{{ old('subtotal', $purchase->subtotal ?? 0) }}" readonly></td>
                                                                </tr>
                                                                <tr>
                                                                    <th>Discount</th>
                                                                    <td><input type="number" step="0.01" id="overallDiscount" name="discount" class="form-control form-control-sm" value="{{ old('discount', $purchase->discount ?? 0) }}" readonly>
                                                                    </td>
                                                                </tr>
                                                                <tr>
                                                                    <th>WHT</th>
                                                                    <td>
                                                                        <div class="input-group">
                                                                            <input type="number" step="0.01" id="whtValue" name="wht" class="form-control form-control-sm" value="{{ old('wht', $purchase->wht ?? 0) }}">
                                                                            <select id="whtType" class="form-select form-select-sm" style="max-width:90px;">
                                                                                <option value="percent" selected>%</option>
                                                                                <option value="amount">PKR</option>
                                                                            </select>
                                                                        </div>
                                                                    </td>
                                                                </tr>

                                                                <tr>
                                                                    <th>WHT Amount</th>
                                                                    <td>
                                                                        <input type="text" id="whtAmount" name="wht_amount" class="form-control form-control-sm" value="0" readonly>
                                                                    </td>
                                                                </tr>


                                                                <tr>
                                                                    <th>Net</th>
                                                                    <td><input type="text" id="netAmount" name="net_amount" class="form-control form-control-sm fw-bold" value="{{ old('net_amount', $purchase->net_amount ?? 0) }}" readonly></td>
                                                                </tr>
                                                            </table>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <button type="submit" class="btn btn-primary btn-sm w-100">Update
                                                Purchase</button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div><!-- bodywrapper__inner end -->
                </div><!-- body-wrapper end -->
        </div>
    </div>
</div>

@endsection

@section('scripts')



@if(session('error'))
<script>
    Swal.fire({
        icon: 'error',
        title: 'Error',
        text: @json(session('error')),
        confirmButtonColor: '#d33',
    });
</script>
@endif

@if (session('success'))
<script>
    Swal.fire({
        icon: 'success',
        title: 'Success',
        text: @json(session('success')),
        confirmButtonColor: '#3085d6',
    });
</script>
@endif






<script>
    (function($) {
        // throttle / single Swal helper
        let lastSwalAt = 0;

        function showOneToast(options = {}) {
            const now = Date.now();
            const throttleMs = options.throttleMs || 1200; // change if you want longer
            // if Swal is visible OR recently shown, skip
            if (typeof Swal !== 'undefined' && Swal.isVisible && Swal.isVisible()) return;
            if (now - lastSwalAt < throttleMs) return;
            lastSwalAt = now;

            if (typeof Swal !== 'undefined') {
                Swal.fire({
                    icon: options.icon || 'info',
                    title: options.title || '',
                    text: options.text || '',
                    timer: options.timer || 1400,
                    showConfirmButton: options.showConfirmButton || false,
                });
            } else {
                // fallback to alert once
                if (now - (window._lastAlertAt || 0) > throttleMs) {
                    alert((options.title ? (options.title + '\n') : '') + (options.text || ''));
                    window._lastAlertAt = now;
                }
            }
        }

        // flag to coordinate pointerdown->blur->click
        let isSelectingSuggestion = false;

        // set flag on pointerdown (fires before blur)
        $(document).on('pointerdown', '.searchResults .search-result-item', function() {
            isSelectingSuggestion = true;
            // clear after short delay to allow click handlers to run
            setTimeout(() => {
                isSelectingSuggestion = false;
            }, 400);
        });

        // Product search key handlers (Tab/Enter) — use showOneToast instead of direct Swal calls
        $(document).on('keydown', '.productSearch', function(e) {
            const $input = $(this);
            const $row = $input.closest('tr');
            const $box = $row.find('.searchResults');

            if (e.key === 'Tab') {
                const pid = $row.find('.product_id').val() || '';
                const $items = $box.children('.search-result-item');
                const hasActive = $items.length && $items.filter('.active').length;

                if (!pid.toString().trim() && !hasActive) {
                    e.preventDefault();
                    $input.addClass('invalid-product');
                    showOneToast({
                        icon: 'warning',
                        title: 'Please select a product',
                        text: 'Choose from suggestions or clear the field.',
                        timer: 1400
                    });
                    setTimeout(() => $input.focus(), 0);
                    return;
                }

                if (!pid.toString().trim() && hasActive) {
                    e.preventDefault();
                    const $active = $items.filter('.active').first();
                    if ($active.length) {
                        // mark selecting to avoid blur race
                        isSelectingSuggestion = true;
                        $active.trigger('click');
                        setTimeout(() => {
                            isSelectingSuggestion = false;
                        }, 400);
                    }
                    setTimeout(() => focusPriceOrQty($row), 0);
                    return;
                }
                // else allow tab normally
            }

            if (e.key === 'Enter') {
                const $items = $box.children('.search-result-item');
                if ($items.length) {
                    e.preventDefault();
                    const idx = $items.index($items.filter('.active'));
                    if (idx >= 0) {
                        isSelectingSuggestion = true;
                        $items.eq(idx).trigger('click');
                        setTimeout(() => {
                            isSelectingSuggestion = false;
                        }, 400);
                    } else if ($items.length === 1) {
                        isSelectingSuggestion = true;
                        $items.eq(0).trigger('click');
                        setTimeout(() => {
                            isSelectingSuggestion = false;
                        }, 400);
                    }
                    setTimeout(() => $row.find('.quantity').focus(), 0);
                } else {
                    e.preventDefault();
                    showOneToast({
                        icon: 'info',
                        title: 'No suggestions',
                        text: 'No matching product found.',
                        timer: 900
                    });
                    $input.focus();
                }
            }
        });





        function focusPriceOrQty($row) {
            const $price = $row.find('.price');
            const $qty = $row.find('.quantity');
            if ($price.length && !$price.prop('readonly') && !$price.prop('disabled')) {
                $price.focus();
                try {
                    $price.select();
                } catch (e) {}
                return;
            }
            if ($qty.length) {
                $qty.focus();
                try {
                    $qty.select();
                } catch (e) {}
            }
        }

        // Click select suggestion — idempotent fill (won't double-fill)
        $(document).on('click', '.search-result-item', function(e) {
            const $li = $(this);
            const $row = $li.closest('tr');

            // visible value
            $row.find('.productSearch').val($li.data('product-name'));
            // hidden field to be posted -> old() will keep it after validation fail
            $row.find('input[name="product_name[]"]').val($li.data('product-name'));

            $row.find('input[name="brand[]"]').val($li.data('product-brand') || '');
            $row.find('.price').val(parseFloat($li.data('price-net') || 0).toFixed(2));
            $row.find('.retail_price_show').val(parseFloat($li.data('price-retail') || 0).toFixed(2));

            $row.find('.purchase_net_amount').val(parseFloat($li.data('price-net') || 0).toFixed(2));
            $row.find('.purchase_retail_price').val(parseFloat($li.data('price-retail') || 0).toFixed(2));
            $row.find('.product_id').val($li.data('product-id'));

            $row.find('.quantity').val(1);
            $row.find('.item_disc').val(0);
            $row.find('.disc_amount').val('0.00');

            if (typeof recalcRow === 'function') recalcRow($row);
            if (typeof recalcSummary === 'function') recalcSummary();

            $row.find('.searchResults').empty();
            setTimeout(() => focusPriceOrQty($row), 0);
        });


        // When selecting active suggestion via Tab/Enter
        // wherever you have code that triggers selection like $active.trigger('click');
        // just ensure you call focusPriceOrQty afterwards, e.g.:
        $active.trigger('click');
        setTimeout(() => focusPriceOrQty($row), 0);

        // blur: do not force refocus if selecting suggestion; show throttled toast instead of multiple modals
        $(document).on('blur', '.productSearch', function() {
            const $input = $(this);
            const $row = $input.closest('tr');

            // if user is clicking a suggestion, skip
            if (isSelectingSuggestion) return;

            setTimeout(() => {
                const pid = $row.find('.product_id').val() || '';
                const txt = $input.val() || '';
                if (txt.toString().trim().length > 0 && !pid.toString().trim()) {
                    // show one toast only (throttled)
                    showOneToast({
                        icon: 'info',
                        title: 'Select product',
                        text: 'Please select a product from the list, or clear the input to skip.',
                        timer: 1200
                    });
                    // do not force focus immediately to avoid flicker (user may click elsewhere)
                }
            }, 160);
        });

    })(jQuery);
</script>

{{-- Item Row Autocomplete + Add/Remove --}}
<!-- Make sure jQuery and Bootstrap Typeahead are included -->

<script>
    (function() {
        // restore old arrays from server (Blade -> JS)
        const oldProducts = @json(old('product_id', []));
        const oldPrices = @json(old('price', []));
        const oldQtys = @json(old('qty', []));
        const oldItemDiscs = @json(old('item_disc', []));
        const oldDiscAmounts = @json(old('item_disc_amount', []));
        const oldRetailPrices = @json(old('purchase_retail_price', []));
        const oldPurchaseNet = @json(old('purchase_net_amount', []));
        const oldRowAmounts = @json(old('total', []));
        const oldProductNames = @json(old('product_name', []));
        const oldBrands = @json(old('brand', []));

        // account allocations
        const oldAccHeads = @json(old('account_head_id', []));
        const oldAccIds = @json(old('account_id', []));
        const oldAccAmounts = @json(old('account_amount', []));

        const errors = @json($errors->toArray());
        const accountHeadsList = @json($AccountHeads);

        // helper: create a product row HTML (same structure as appendBlankRow)
        function makeRowHtml(data, index = null) {
            // Error handling helper
            const getError = (field) => {
                if (index !== null && errors[field + '.' + index]) {
                     return `<div class="alert alert-danger p-1 mt-1" style="font-size: 12px; margin-bottom:0;">${errors[field + '.' + index][0]}</div>`;
                }
                return '';
            };

            // data: { product_id, product_name, brand, price, retail_show, item_disc, disc_amount, qty, row_amount, row_total, purchase_retail, purchase_net }
            return `
      <tr>
        <td>
          <input type="hidden" name="product_id[]" class="product_id" value="${data.product_id || ''}">
          <input type="hidden" name="product_name[]" class="product_name_hidden" value="${(data.product_name || '')}">
          <input type="text" class="form-control form-control-sm productSearch" placeholder="Search product..." autocomplete="off" value="${(data.product_name||'')}">
          ${getError('product_id')}
          <div class="searchResults"></div>
        </td>
        <td class="uom border">
          <input type="text" name="brand[]" class="form-control form-control-sm" readonly value="${data.brand || ''}">
        </td>
        <td>
          <input type="number" step="0.01" name="price[]" class="form-control form-control-sm price" value="${data.price || ''}">
          ${getError('price')}
        </td>
        <td>
          <input type="text" name="retail_price_show[]" class="form-control form-control-sm retail_price_show" readonly value="${data.retail_show || ''}">
        </td>
        <td>
          <div class="input-group">
            <input type="number" step="0.01" min="0" name="item_disc[]" class="form-control form-control-sm item_disc" placeholder="%" value="${data.item_disc || ''}">
            <input type="text" name="item_disc_amount[]" class="form-control form-control-sm disc_amount" readonly placeholder="Disc Amt" value="${data.disc_amount || ''}">
          </div>
          ${getError('item_disc')}
          <input type="hidden" name="purchase_retail_price[]" class="purchase_retail_price" value="${data.purchase_retail || ''}">
          <input type="hidden" name="purchase_net_amount[]" class="purchase_net_amount" value="${data.purchase_net || ''}">
        </td>
        <td>
          <input type="number" name="qty[]" class="form-control form-control-sm quantity" value="${data.qty || 1}" min="1">
          ${getError('qty')}
        </td>
        <td>
          <input type="text" name="amount[]" class="form-control form-control-sm row-amount" readonly value="${data.row_amount || ''}">
        </td>
        <td>
          <input type="text" name="total[]" class="form-control form-control-sm row-total" readonly value="${data.row_total || ''}">
        </td>
        <td>
          <button type="button" class="btn btn-sm btn-danger remove-row">X</button>
        </td>
      </tr>
    `;
        }

        function restoreProducts() {
            // if there is no old product data, do nothing (keep initial blank row)
            if (!oldProducts || oldProducts.length === 0) return;

            // clear current rows
            $('#purchaseItems').empty();

            const max = Math.max(oldProducts.length, oldPrices.length, oldQtys.length);

            for (let i = 0; i < max; i++) {
                const rowData = {
                    product_id: oldProducts[i] ?? '',
                    product_name: (oldProductNames[i] ?? ''),
                    brand: (oldBrands[i] ?? ''),
                    price: oldPrices[i] ?? '',
                    retail_show: oldRetailPrices[i] ?? '',
                    item_disc: oldItemDiscs[i] ?? '',
                    disc_amount: oldDiscAmounts[i] ?? '',
                    purchase_retail: oldRetailPrices[i] ?? '',
                    purchase_net: oldPurchaseNet[i] ?? '',
                    qty: oldQtys[i] ?? 1,
                    row_amount: '', // will be recalculated
                    row_total: oldRowAmounts[i] ?? ''
                };

                $('#purchaseItems').append(makeRowHtml(rowData, i));
            }

            // re-bind any plugin stuff? (your handlers are delegated so okay)
            // Recalculate rows and summary
            $('#purchaseItems tr').each(function() {
                try {
                    if (typeof recalcRow === 'function') recalcRow($(this));
                } catch (err) {
                    console && console.error && console.error('recalcRow on restore error', err);
                }
            });
            if (typeof recalcSummary === 'function') recalcSummary();

            // focus last product search to allow quick continue
            setTimeout(function() {
                $('#purchaseItems tr:last .productSearch').focus();
            }, 80);
        }

        function restoreAccounts() {
            if (!oldAccHeads || oldAccHeads.length === 0) return;

            // clear table except header
            $('#accountsTable tbody').empty();

            const max = Math.max(oldAccHeads.length, oldAccIds.length, oldAccAmounts.length);
            for (let i = 0; i < max; i++) {
                const head = oldAccHeads[i] ?? '';
                const acc = oldAccIds[i] ?? '';
                const amt = oldAccAmounts[i] ?? '';

                const getError = (field) => {
                    if (errors[field + '.' + i]) {
                        return `<div class="alert alert-danger p-1 mt-1" style="font-size: 12px; margin-bottom:0;">${errors[field + '.' + i][0]}</div>`;
                    }
                    return '';
                };

                let optionsHtml = '<option value="" disabled>Select Head</option>';
                if(accountHeadsList && accountHeadsList.length) {
                    accountHeadsList.forEach(h => {
                        const selected = (String(head) === String(h.id)) ? 'selected' : '';
                        optionsHtml += `<option value="${h.id}" ${selected}>${h.name}</option>`;
                    });
                }

                const row = `
        <tr>
          <td>
            <select name="account_head_id[]" class="form-control form-control-sm accountHead">
              ${optionsHtml}
            </select>
            ${getError('account_head_id')}
          </td>
          <td>
            <select name="account_id[]" class="form-control form-control-sm accountSub">
               <!-- We might not have options loaded yet if we rely solely on trigger change. 
                    However, we can force-load them manually here or allow the trigger to handle it.
                    Since we set value="${acc}", if options arrive later, we must re-select.
               -->
              <option value="${acc}" selected>${acc}</option>
            </select>
            ${getError('account_id')}
          </td>
          <td>
            <input type="number" step="0.01" name="account_amount[]" class="form-control form-control-sm accountAmount" value="${amt || 0}">
             ${getError('account_amount')}
          </td>
          <td>
            <button type="button" class="btn btn-sm btn-danger removeAccountRow">X</button>
          </td>
        </tr>
      `;
                $('#accountsTable tbody').append(row);
                
                // Trigger change to load accounts if head is selected
                if(head) {
                     const $lastRow = $('#accountsTable tbody tr:last');
                     // Manually call the load logic effectively to ensure value is preserved
                     const headId = head;
                     const $accountSelect = $lastRow.find('.accountSub');
                     const $amountInput = $lastRow.find('.accountAmount');
                     
                     // Enable inputs
                     $accountSelect.prop('disabled', false).prop('required', true);
                     $amountInput.prop('disabled', false).prop('required', true).attr('min', '0.01');

                     $.ajax({
                        url: "{{ url('/get-accounts-by-head') }}/" + headId,
                        type: "GET",
                        dataType: 'json',
                        success: function(res) {
                            // keep logic similar to change handler
                            const currentAcc = acc; // The value we want to restore
                            let html = '<option value="" disabled>Select Account</option>';
                            if (Array.isArray(res) && res.length) {
                                res.forEach(a => {
                                    const selected = String(a.id) === String(currentAcc) ? ' selected' : '';
                                    html += `<option value="${a.id}"${selected}>${a.title}</option>`;
                                });
                            }
                            $accountSelect.html(html);
                            
                            // If currentAcc was set but not in list (shouldn't happen if valid), handle
                            if (!currentAcc) {
                                $accountSelect.prepend('<option value="" disabled selected>Select Account</option>');
                                $accountSelect.val('');
                            }
                            if (typeof recalcAccountsTotal === 'function') recalcAccountsTotal();
                        },
                        error: function() {
                             // retain what we have or show error, but better to keep enabled if possible
                             if (typeof recalcAccountsTotal === 'function') recalcAccountsTotal();
                        }
                    });
                }
            }

            // trigger recalc of allocations
            if (typeof recalcAccountsTotal === 'function') recalcAccountsTotal();
        }

        // Run restore on DOM ready (after your other handlers)
        $(function() {
            try {
                restoreProducts();
                restoreAccounts();
            } catch (e) {
                console && console.error && console.error('restore error', e);
            }
        });
    })();

    $(document).ready(function() {

        function num(n) {
            return isNaN(parseFloat(n)) ? 0 : parseFloat(n);
        }

        function recalcRow($row) {
            // Robust number parser
            const getVal = (selector) => {
                let val = $row.find(selector).val();
                return (val === '' || val === undefined || val === null) ? 0 : parseFloat(val);
            };

            // Quantity logic:
            // If user clears quantity (empty string), treat it as 1 for "Total" calculation
            // so they see the single unit price as the total.
            // Only if they explicitly type 0 does it become 0.
            let qRaw = $row.find('.quantity').val();
            let qty = (qRaw === '' || qRaw === null || isNaN(parseFloat(qRaw))) ? 1 : parseFloat(qRaw);

            const priceInput = getVal('.price'); 
            const purchaseNet = getVal('.purchase_net_amount'); 
            const purchaseRetail = getVal('.purchase_retail_price');
            const discPercent = getVal('.item_disc');

            // Determine Base Unit Price
            let baseUnit = priceInput;
            if (baseUnit === 0 && purchaseNet > 0) {
                 baseUnit = purchaseNet;
            }

            // Calculate Discount
            const discBase = (purchaseRetail > 0) ? purchaseRetail : baseUnit;
            const perUnitDisc = discBase * (discPercent / 100);

            // Calculate Final Unit Amount
            let perUnitAmount = baseUnit - perUnitDisc;
            if (perUnitAmount < 0) perUnitAmount = 0;

            // Calculate Total
            const rowTotal = perUnitAmount * qty;

            // Update UI Fields
            const format = (n) => isNaN(n) ? '0.00' : n.toFixed(2);

            $row.find('.disc_amount').val(format(perUnitDisc * qty));
            $row.find('.row-amount').val(format(perUnitAmount));
            $row.find('.row-total').val(format(rowTotal));
        }


        $('#overallDiscount, #whtValue, #whtType').on('input change', function() {
            recalcSummary();
        });

        $('#purchaseItems').on('input', '.quantity, .item_disc, .price', function() {
            const $row = $(this).closest('tr');
            recalcRow($row);
            recalcSummary();
        });

        // Auto-select value when focusing on numeric fields
        // This ensures typing replaces the value instead of appending
        $('#purchaseItems').on('focus', '.quantity, .item_disc, .price', function() {
            $(this).select();
        });


        function recalcSummary() {
            let sub = 0;
            $('#purchaseItems .row-total').each(function() {
                sub += num($(this).val());
            });
            $('#subtotal').val(sub.toFixed(2));

            const oDisc = num($('#overallDiscount').val());
            let whtVal = num($('#whtValue').val());
            const whtType = $('#whtType').val();

            // Calculate WHT amount (separate field)
            let whtAmount = 0;
            if (whtType === 'percent') {
                // percent of (subtotal - overallDiscount)
                const taxable = Math.max(0, sub - oDisc);
                whtAmount = taxable * (whtVal / 100);
            } else {
                // amount in PKR
                whtAmount = whtVal;
            }

            // show WHT amount
            $('#whtAmount').val(whtAmount.toFixed(2));

            // Net = Subtotal - Overall Discount - WHTAmount
            const net = sub - oDisc - whtAmount;
            $('#netAmount').val(net.toFixed(2));
        }

        function lastRowHasProduct() {
            const $last = $('#purchaseItems tr:last');
            if (!$last.length) return false;
            const pid = $last.find('.product_id').val() || '';
            return pid.toString().trim().length > 0;
        }



        function appendBlankRow() {
            // only append if last row has product selected (prevents extra empties)
            if ($('#purchaseItems tr').length > 0 && !lastRowHasProduct()) {
                // focus the product field of last row to encourage selection
                $('#purchaseItems tr:last .productSearch').focus();
                return;
            }

            const newRow = `
      <tr>
        <!-- Product -->
         <td>
      <input type="hidden" name="product_id[]" class="product_id">
      <input type="hidden" name="product_name[]" class="product_name_hidden" value="">
      <input type="text" class="form-control form-control-sm productSearch" placeholder="Enter product name..." autocomplete="off" value="">
      <div class="searchResults"></div>
    </td>

        <!-- Brand -->
        <td class="uom border">
            <input type="text" name="brand[]" class="form-control form-control-sm" readonly>
        </td>

        <!-- Price -->
        <td>
            <input type="number" step="0.01" name="price[]" class="form-control form-control-sm price">
        </td>

        <!-- Retail Price (visible) -->
        <td>
            <input type="text" name="retail_price_show[]" class="form-control form-control-sm retail_price_show" readonly>
        </td>

        <!-- Discount (percent) + Discount Amount (visible) + hidden purchase prices -->
        <td>
          <div class="input-group">
            <input type="number" step="0.01" min="0" name="item_disc[]" class="form-control form-control-sm item_disc" placeholder="%">
            <input type="text" name="item_disc_amount[]" class="form-control form-control-sm disc_amount" readonly placeholder="Disc Amt">
          </div>
          <input type="hidden" name="purchase_retail_price[]" class="purchase_retail_price">
          <input type="hidden" name="purchase_net_amount[]" class="purchase_net_amount">
        </td>

        <!-- Quantity -->
        <td class="qty">
            <input type="number" name="qty[]" class="form-control form-control-sm quantity" value="" min="1">
        </td>

        <!-- Amount (unit after discount shown) -->
        <td>
            <input type="text" name="amount[]" class="form-control form-control-sm row-amount" readonly>
        </td>

        <!-- Total (amount * qty) -->
        <td class="total border">
            <input type="text" name="total[]" class="form-control form-control-sm row-total" readonly>
        </td>

        <!-- Remove -->
        <td>
            <button type="button" class="btn btn-sm btn-danger remove-row">X</button>
        </td>
      </tr>`;
            $('#purchaseItems').append(newRow);
        }

        // ---------- Product Search (AJAX) with Debouncing ----------
        let searchTimeout = null;
        
        $(document).on('keyup', '.productSearch', function(e) {
            const $input = $(this);
            const q = $input.val().trim();
            const $row = $input.closest('tr');
            const $box = $row.find('.searchResults');

            // keyboard nav
            const isNavKey = ['ArrowDown', 'ArrowUp', 'Enter'].includes(e.key);
            if (isNavKey && $box.children('.search-result-item').length) {
                const $items = $box.children('.search-result-item');
                let idx = $items.index($items.filter('.active'));
                if (e.key === 'ArrowDown') {
                    idx = (idx + 1) % $items.length;
                    $items.removeClass('active');
                    $items.eq(idx).addClass('active');
                    
                    // Auto-scroll to keep active item visible
                    const itemTop = $items.eq(idx).position().top;
                    const containerHeight = $box.height();
                    if (itemTop > containerHeight - 50) {
                        $box.scrollTop($box.scrollTop() + 50);
                    }
                    
                    e.preventDefault();
                    return;
                }
                if (e.key === 'ArrowUp') {
                    idx = (idx <= 0 ? $items.length - 1 : idx - 1);
                    $items.removeClass('active');
                    $items.eq(idx).addClass('active');
                    
                    // Auto-scroll to keep active item visible
                    const itemTop = $items.eq(idx).position().top;
                    if (itemTop < 0) {
                        $box.scrollTop($box.scrollTop() - 50);
                    }
                    
                    e.preventDefault();
                    return;
                }
                if (e.key === 'Enter') {
                    if (idx >= 0) {
                        $items.eq(idx).trigger('click');
                    } else if ($items.length === 1) {
                        $items.eq(0).trigger('click');
                    }
                    e.preventDefault();
                    return;
                }
            }

            if (q.length === 0) {
                $box.empty();
                $input.removeClass('searching');
                return;
            }

            // Debouncing: Clear previous timeout
            if (searchTimeout) {
                clearTimeout(searchTimeout);
            }

            // Show loading state
            $box.html('<div class="search-loading"><i class="bi bi-arrow-repeat" style="animation: spin 1s linear infinite;"></i> Searching...</div>');
            $input.addClass('searching');

            // Debounce search by 300ms for better performance
            searchTimeout = setTimeout(function() {
                $.ajax({
                    url: "{{ route('search-products') }}",
                    type: 'GET',
                    data: { q: q },
                    success: function(data) {
                        $input.removeClass('searching');
                        
                        if (!data || data.length === 0) {
                            $box.html('<div class="search-no-results"><i class="bi bi-inbox"></i><br>No products found</div>');
                            return;
                        }

                        let html = '';
                        // Limit results to 50 for better performance
                        const results = data.slice(0, 50);
                        
                        results.forEach(p => {
                            const brand = p.brand ?? 'N/A';
                            const net = parseFloat(p.purchase_net_amount ?? 0).toFixed(2);
                            const retail = parseFloat(p.purchase_retail_price ?? 0).toFixed(2);
                            const name = p.name ?? '';
                            const id = p.id ?? '';
                            
                            // Get first letter for icon
                            const firstLetter = name.charAt(0).toUpperCase();

                            html += `
                                <div class="search-result-item"
                                    tabindex="0"
                                    data-product-id="${id}"
                                    data-product-name="${name}"
                                    data-product-brand="${brand}"
                                    data-price-net="${net}"
                                    data-price-retail="${retail}">
                                    <div class="product-icon">
                                        <i class="bi bi-box-seam"></i>
                                    </div>
                                    <div class="product-info">
                                        <div class="product-name">${name}</div>
                                        <div class="product-brand">${brand}</div>
                                    </div>
                                    <div class="product-price">Rs. ${net}</div>
                                </div>`;
                        });
                        
                        if (data.length > 50) {
                            html += '<div class="search-loading" style="background: #fef3c7; color: #92400e; padding: 8px;">Showing top 50 results. Refine search for more.</div>';
                        }

                        $box.html(html);
                        $box.find('.search-result-item').first().addClass('active');
                    },
                    error: function() {
                        $input.removeClass('searching');
                        $box.html('<div class="search-no-results"><i class="bi bi-exclamation-triangle"></i><br>Search failed</div>');
                    }
                });
            }, 300); // 300ms debounce
        });

        // Click/Enter select suggestion
        $(document).on('click', '.search-result-item', function() {
            const $li = $(this);
            const $row = $li.closest('tr');

            // Get product data
            const pName = $li.attr('data-product-name');
            const pBrand = $li.attr('data-product-brand');
            const pPriceNet = parseFloat($li.attr('data-price-net') || 0);
            const pPriceRetail = parseFloat($li.attr('data-price-retail') || 0);
            const pId = $li.attr('data-product-id');

            // Set all product fields
            $row.find('.product_id').val(pId);
            $row.find('.product_name_hidden').val(pName);
            $row.find('.productSearch').val(pName);
            $row.find('input[name="brand[]"]').val(pBrand || '');
            
            // Set prices
            $row.find('.price').val(pPriceNet.toFixed(2));
            $row.find('.retail_price_show').val(pPriceRetail.toFixed(2));
            $row.find('.purchase_net_amount').val(pPriceNet.toFixed(2));
            $row.find('.purchase_retail_price').val(pPriceRetail.toFixed(2));

            // Set discount to 0, but leave quantity EMPTY
            $row.find('.quantity').val(''); // Empty - user will enter after discount
            $row.find('.item_disc').val(0);
            $row.find('.disc_amount').val('0.00');

            // Clear search results
            $row.find('.searchResults').empty();
            
            // Move focus to Price field
            $row.find('.price').focus();
            $row.find('.price').select();
        });





        $(document).on('keydown', '#purchaseItems input', function(e) {
            const isProductSearch = $(this).hasClass('productSearch');
            
            // Handle Enter key navigation
            if (e.key === 'Enter' && !isProductSearch) {
                e.preventDefault(); // stop submit
                const $row = $(this).closest('tr');

                // 1. Price -> Discount
                if ($(this).hasClass('price')) {
                    $row.find('.item_disc').focus();
                    $row.find('.item_disc').select();
                    return false;
                }

                // 2. Discount -> Quantity
                if ($(this).hasClass('item_disc')) {
                    $row.find('.quantity').focus();
                    $row.find('.quantity').select();
                    return false;
                }

                // 3. Quantity -> Next Row (or create new)
                if ($(this).hasClass('quantity')) {
                    const productIdVal = $row.find('.product_id').val() || '';
                    if (!productIdVal) {
                        // if no product, force go back to product search
                        $row.find('.productSearch').focus();
                        return false;
                    }
                    
                    const isLast = $row.is(':last-child');
                    if (isLast) {
                        appendBlankRow();
                        // focus moved to new row in appendBlankRow, but let's ensure
                        $('#purchaseItems tr:last .productSearch').focus();
                    } else {
                        $row.next().find('.productSearch').focus();
                    }
                    return false;
                }

                // Fallback for other inputs: move to next visible input
                let $next = $row.find('input,select,button').filter(':visible').toArray();
                let idx = $next.indexOf(e.target);
                if (idx >= 0 && idx < $next.length - 1) {
                    $($next[idx + 1]).focus();
                }
                return false;
            }
        });

        function initRecalcAllRows() {
            $('#purchaseItems tr').each(function() {
                try {
                    if (typeof recalcRow === 'function') recalcRow($(this));
                } catch (err) {
                    // ignore individual row errors but log for debugging
                    console && console.error && console.error('recalcRow error', err);
                }
            });
            if (typeof recalcSummary === 'function') recalcSummary();
        }

        // call it now (inside ready)
        initRecalcAllRows();


        // keyboard Enter on suggestion list
        $(document).on('keydown', '.searchResults .search-result-item', function(e) {
            if (e.key === 'Enter') {
                $(this).trigger('click');
            }
        });

        // On change of qty or discount percent recalc
        $('#purchaseItems').on('input', '.quantity, .item_disc', function() {
            const $row = $(this).closest('tr');
            recalcRow($row);
            recalcSummary();
        });

        $('#purchaseItems').on('input', '.price', function() {
            const $row = $(this).closest('tr');
            recalcRow($row);
            recalcSummary();
        });

        // Remove row
        $(document).on('click', '.remove-row', function(e) {
            e.preventDefault();
            const $row = $(this).closest('tr');
            const rowCount = $('#purchaseItems tr').length;

            if (rowCount === 1) {
                if (typeof Swal !== 'undefined') {
                    Swal.fire({
                        icon: 'warning',
                        title: 'At least one row required',
                        text: 'You cannot remove the last row. The row will be cleared instead.',
                        timer: 1200,
                        showConfirmButton: false
                    });
                }
                // clear fields
                $row.find('.product_id').val('');
                $row.find('.productSearch').val('');
                $row.find('input[name="brand[]"]').val('');
                $row.find('.price').val('');
                $row.find('.retail_price_show').val('');
                $row.find('.purchase_retail_price').val('');
                $row.find('.purchase_net_amount').val('');
                $row.find('.quantity').val(1);
                $row.find('.item_disc').val(0);
                $row.find('.disc_amount').val('0.00');
                $row.find('.row-amount').val('0.00');
                $row.find('.row-total').val('0.00');
                $row.find('.searchResults').empty();

                if (typeof recalcRow === 'function') recalcRow($row);
                if (typeof recalcSummary === 'function') recalcSummary();

                setTimeout(() => $row.find('.productSearch').focus(), 50);
                return;
            }

            // normal remove
            $row.remove();
            if ($('#purchaseItems tr').length === 0) {
                if (typeof appendBlankRow === 'function') appendBlankRow();
            }
            if (typeof recalcSummary === 'function') recalcSummary();
        });


        // Summary inputs
        $('#overallDiscount, #extraCost').on('input', function() {
            recalcSummary();
        });

        // init first row
        recalcRow($('#purchaseItems tr:first'));
        recalcSummary();


        $('#addAccountRow').on('click', function() {
            const heads = @json($AccountHeads);
            let headOptions = '<option value="" disabled selected>Select Head</option>';
            heads.forEach(h => {
                headOptions += `<option value="${h.id}">${h.name}</option>`;
            });

            let newRow = `
<tr>
  <td>
    <select name="account_head_id[]" class="form-control form-control-sm accountHead">
      ${headOptions}
    </select>
  </td>
  <td>
    <select name="account_id[]" class="form-control form-control-sm accountSub" disabled>
      <option value="" disabled selected>Select Account</option>
    </select>
  </td>
  <td>
    <input type="number" step="0.01" name="account_amount[]" class="form-control form-control-sm accountAmount" value="" disabled>
  </td>
  <td>
    <button type="button" class="btn btn-sm btn-danger removeAccountRow">X</button>
  </td>
</tr>`;
            $('#accountsTable tbody').append(newRow);

        });

        // --- Remove Row ---
        $(document).on('click', '.removeAccountRow', function() {
            $(this).closest('tr').remove();
            recalcAccountsTotal();
        });

        // --- Load Accounts on Head Change ---
        // Toggle Account and Amount required/enabled depending on Account Head selection
        $(document).on('change', '.accountHead', function() {
            const $row = $(this).closest('tr');
            const headId = $(this).val();
            const $accountSelect = $row.find('.accountSub');
            const $amountInput = $row.find('.accountAmount');

            // If no head selected -> disable & clear account+amount
            if (!headId || headId.toString().trim() === '') {
                $accountSelect.prop('disabled', true).prop('required', false)
                    .html('<option value="" disabled selected>Select Account</option>');
                $amountInput.prop('disabled', true).prop('required', false).val('');
                if (typeof recalcAccountsTotal === 'function') recalcAccountsTotal();
                return;
            }

            // Head selected -> enable account and amount (will be required)
            $accountSelect.prop('disabled', false).prop('required', true);
            $amountInput.prop('disabled', false).prop('required', true).attr('min', '0.01');

            // Fetch accounts for this head (AJAX)
            $.ajax({
                url: "{{ url('/get-accounts-by-head') }}/" + headId,
                type: "GET",
                dataType: 'json',
                success: function(res) {
                    // keep current account value (if any) to try to re-select after fill
                    const currentAcc = $accountSelect.val();
                    let html = '<option value="" disabled>Select Account</option>';
                    if (Array.isArray(res) && res.length) {
                        res.forEach(acc => {
                            // Use === comparison with strings to avoid type issues
                            const selected = String(acc.id) === String(currentAcc) ? ' selected' : '';
                            html += `<option value="${acc.id}"${selected}>${acc.title}</option>`;
                        });
                    }
                    $accountSelect.html(html);
                    // if previously no account chosen, set placeholder selected
                    if (!currentAcc) {
                        $accountSelect.prepend('<option value="" disabled selected>Select Account</option>');
                        $accountSelect.val('');
                    }
                    if (typeof recalcAccountsTotal === 'function') recalcAccountsTotal();
                },
                error: function() {
                    // on error: disable account and clear
                    $accountSelect.prop('disabled', true).prop('required', false)
                        .html('<option value="" disabled selected>Select Account</option>');
                    $amountInput.prop('disabled', true).prop('required', false).val('');
                    if (typeof recalcAccountsTotal === 'function') recalcAccountsTotal();
                }
            });
        });


        // --- Enable Amount field only when Account is selected ---
        $(document).on('change', '.accountSub', function() {
            const $row = $(this).closest('tr');
            const accountId = $(this).val();
            const $amountInput = $row.find('.accountAmount');
            
            // If account selected, enable amount field
            if (accountId && accountId.toString().trim() !== '') {
                $amountInput.prop('disabled', false).prop('required', true).attr('min', '0.01');
            } else {
                // If no account selected, disable amount and clear value
                $amountInput.prop('disabled', true).prop('required', false).val('');
                if (typeof recalcAccountsTotal === 'function') recalcAccountsTotal();
            }
        });

        // --- Recalc Accounts Total ---
        $(document).on('input', '.accountAmount', function() {
            recalcAccountsTotal();
        });

        function recalcAccountsTotal() {
            let total = 0;
            $('.accountAmount').each(function() {
                total += parseFloat($(this).val()) || 0;
            });
            $('#accountsTotal').val(total.toFixed(2));

            // propagate to overallDiscount (existing behavior)
            $('#overallDiscount').val(total.toFixed(2));
            recalcSummary();
        }

        $(document).on('input', '.accountAmount', recalcAccountsTotal);

        // init first row and summary
        recalcRow($('#purchaseItems tr:first'));
        recalcSummary();


    });

    $('#purchaseForm').on('submit', function(e) {
        // remove any item rows that do not have a product selected
        $('#purchaseItems tr').each(function() {
            const pid = $(this).find('.product_id').val() || '';
            // if product id blank OR productSearch text blank, remove row
            const name = $(this).find('.productSearch').val() || '';
            if (!pid.toString().trim() && !name.toString().trim()) {
                $(this).remove();
            }
        });

        // Safe guard: if all rows were removed (because empty), add one back
        if ($('#purchaseItems tr').length === 0) {
            if (typeof appendBlankRow === 'function') {
                appendBlankRow(); 
            } else {
                 // Fallback if function is somehow not reachable (though it should be)
                 const fallbackRow = `<tr><td><input type="hidden" name="product_id[]" class="product_id"><input type="hidden" name="product_name[]" class="product_name_hidden"><input type="text" class="form-control form-control-sm productSearch" placeholder="Search product..."><div class="searchResults"></div></td><td class="uom border"><input type="text" name="brand[]" class="form-control form-control-sm" readonly></td><td><input type="number" step="0.01" name="price[]" class="form-control form-control-sm price"></td><td><input type="text" name="retail_price_show[]" class="form-control form-control-sm retail_price_show" readonly></td><td><div class="input-group"><input type="number" step="0.01" min="0" name="item_disc[]" class="form-control form-control-sm item_disc" placeholder="%"><input type="text" name="item_disc_amount[]" class="form-control form-control-sm disc_amount" readonly placeholder="Disc Amt"></div><input type="hidden" name="purchase_retail_price[]" class="purchase_retail_price"><input type="hidden" name="purchase_net_amount[]" class="purchase_net_amount"></td><td><input type="number" name="qty[]" class="form-control form-control-sm quantity" value="1" min="1"></td><td><input type="text" name="amount[]" class="form-control form-control-sm row-amount" readonly></td><td><input type="text" name="total[]" class="form-control form-control-sm row-total" readonly></td><td><button type="button" class="btn btn-sm btn-danger remove-row">X</button></td></tr>`;
                 $('#purchaseItems').append(fallbackRow);
            }
        }

        // after removal, check if we still have at least one valid row
        if ($('#purchaseItems .product_id').filter(function() {
                return $(this).val().toString().trim() !== '';
            }).length === 0) {
            e.preventDefault();
            Swal.fire({
                icon: 'warning',
                title: 'No item selected',
                text: 'Please add at least one valid item before saving.'
            });
            return false;
        }

        // optionally, still re-run client recalc to ensure totals are accurate
        recalcSummary();
        return true; // allow submit
    });


    // ========== VENDOR / TYPE HANDLING ==========

    function loadVendors(type, selectedVendorId = null) {
        let $vendorSelect = $('select[name="vendor_id"]');
        $vendorSelect.empty().append('<option disabled selected>Loading...</option>');

        // Map 'vendor', 'customer', 'walking customer' keys to correct route parameters if needed
        // Assuming your 'party.list' route accepts 'type' as 'vendor' or 'customer'
        
        let apiType = type;
        if(type === 'walkin') apiType = 'customer'; // usually walkin is handled as customer or separate

        $.get('{{ route("party.list") }}', { type: apiType }, function(data) {
            $vendorSelect.empty().append('<option value="" disabled selected>Select</option>');
            if(Array.isArray(data)) {
                data.forEach(function(item) {
                     let isSel = (selectedVendorId && String(item.id) === String(selectedVendorId)) ? 'selected' : '';
                     $vendorSelect.append(`<option value="${item.id}" ${isSel}>${item.text}</option>`);
                });
            }
        }).fail(function() {
             $vendorSelect.empty().append('<option value="" disabled>Error loading</option>');
        });
    }

    $(document).on('change', 'select[name="vendor_type"]', function() {
        // When user manually changes type, load vendors and reset selection
        let type = $(this).val();
        loadVendors(type, null);
    });

    $(function() {
    // ========== EDIT MODE: Restore Purchase Data ==========
    
    // We can use Blade to inject the Purchase data into JS variables
    const purchase = @json($purchase);
    const purchaseItems = @json($purchase->items);
    const allocations = @json($purchase->accountAllocations);
    
    // 1. Restore Vendor Type & ID
    // Derive type from purchasable_type
    let vendorType = 'vendor'; 
    let vendorId = purchase.vendor_id || purchase.purchasable_id; // fallback

    if (purchase.purchasable_type) {
        if (purchase.purchasable_type.toLowerCase().includes('customer')) {
            vendorType = 'customer';
        } else if (purchase.purchasable_type.toLowerCase().includes('vendor')) {
            vendorType = 'vendor';
        }
        // Check if walkin logic exists, if handled via type
    }
    
    // Set the select box
    $('select[name="vendor_type"]').val(vendorType);
    
    // Load vendors and select the correct ID
    loadVendors(vendorType, vendorId);


    // 2. Restore Purchase Items
    if (purchaseItems && purchaseItems.length > 0) {
        $('#purchaseItems').empty(); // Remove default blank row
        
        purchaseItems.forEach(item => {
             // Calculate/Format values
             let price = parseFloat(item.price || 0);
             let qty = parseFloat(item.qty || 1);
             let itemDisc = parseFloat(item.item_discount || 0);
             // derived values for display
             // Assuming item_discount is % ? If it's amount, adjust logic. 
             // Based on previous code, item_discount seems to be %. 
             // Let's verify: In create UI, item_disc is placeholder="%"
             
             let discAmt = (price * (itemDisc / 100)) * qty;
             let rowAmount = price; // unit price
             let lineTotal = (price * qty) - discAmt;
             
             // Get Product Name/Brand (lazy load or safe access)
             let pName = item.product ? item.product.name : '';
             let pBrand = item.product && item.product.brand ? item.product.brand.name : '';
             
             // Latest price for display (optional)
             let retail = item.product && item.product.latest_price ? item.product.latest_price.retail_price : 0;

             let newRow = `
              <tr>
                <!-- Product -->
                 <td>
              <input type="hidden" name="product_id[]" class="product_id" value="${item.product_id}">
              <input type="hidden" name="product_name[]" class="product_name_hidden" value="${pName}">
              <input type="text" class="form-control form-control-sm productSearch" placeholder="Enter product name..." autocomplete="off" value="${pName}">
              <div class="searchResults"></div>
            </td>

                <!-- Brand -->
                <td class="uom border">
                    <input type="text" name="brand[]" class="form-control form-control-sm" readonly value="${pBrand}">
                </td>

                <!-- Price -->
                <td>
                    <input type="number" step="0.01" name="price[]" class="form-control form-control-sm price" value="${price.toFixed(2)}">
                </td>

                <!-- Retail Price (visible) -->
                <td>
                    <input type="text" name="retail_price_show[]" class="form-control form-control-sm retail_price_show" readonly value="${parseFloat(retail).toFixed(2)}">
                </td>

                <!-- Discount -->
                <td>
                  <div class="input-group">
                    <input type="number" step="0.01" min="0" name="item_disc[]" class="form-control form-control-sm item_disc" placeholder="%" value="${itemDisc}">
                    <input type="text" name="item_disc_amount[]" class="form-control form-control-sm disc_amount" readonly placeholder="Disc Amt" value="${discAmt.toFixed(2)}">
                  </div>
                  <input type="hidden" name="purchase_retail_price[]" class="purchase_retail_price" value="${parseFloat(retail).toFixed(2)}">
                  <input type="hidden" name="purchase_net_amount[]" class="purchase_net_amount" value="${price.toFixed(2)}">
                </td>

                <!-- Quantity -->
                <td class="qty">
                    <input type="number" name="qty[]" class="form-control form-control-sm quantity" min="1" value="${qty}">
                </td>

                <!-- Amount -->
                <td>
                    <input type="text" name="amount[]" class="form-control form-control-sm row-amount" readonly value="${price.toFixed(2)}">
                </td>

                <!-- Total -->
                <td class="total border">
                    <input type="text" name="total[]" class="form-control form-control-sm row-total" readonly value="${lineTotal.toFixed(2)}">
                </td>

                <!-- Remove -->
                <td>
                    <button type="button" class="btn btn-sm btn-danger remove-row">X</button>
                </td>
              </tr>`;
            $('#purchaseItems').append(newRow);
        });
        
        // Add blank row at end for convenience? Maybe not in edit mode to keep it clean.
        appendBlankRow();
    }

    // 3. Restore Account Allocations
    if(allocations && allocations.length > 0) {
        // The default PHP loop in HTML might render if there are any, but we are doing it via JS for strict control
        // Actually, the HTML had a PHP loop: @foreach ($AccountHeads as $head) ...
        // But the TABLE BODY for allocations was effectively empty or had a template row. 
        // Let's clear and rebuild.
        $('#accountsTable tbody').empty();
        
        const headsData = @json($AccountHeads);
        
        allocations.forEach(alloc => {
            let headOptions = '<option value="" disabled>Select Head</option>';
            headsData.forEach(h => {
                let s = (String(h.id) === String(alloc.account_head_id)) ? 'selected' : '';
                headOptions += `<option value="${h.id}" ${s}>${h.name}</option>`;
            });
            
            let rowHtml = `
            <tr>
              <td>
                <select name="account_head_id[]" class="form-control form-control-sm accountHead">
                  ${headOptions}
                </select>
              </td>
              <td>
                <select name="account_id[]" class="form-control form-control-sm accountSub" required>
                  <option value="${alloc.account_id}" selected>Loading...</option>
                </select>
              </td>
              <td>
                <input type="number" step="0.01" name="account_amount[]" class="form-control form-control-sm accountAmount" value="${alloc.amount}">
              </td>
              <td>
                <button type="button" class="btn btn-sm btn-danger removeAccountRow">X</button>
              </td>
            </tr>`;
            
            let $row = $(rowHtml);
            $('#accountsTable tbody').append($row);
            
            // Now trigger the AJAX to load the proper account list for this head
            // and keep the selected account
            let headId = alloc.account_head_id;
            let $accSelect = $row.find('.accountSub');
            
            $.ajax({
                url: "{{ url('/get-accounts-by-head') }}/" + headId, // Ensure this route exists or matches your setup
                type: "GET",
                dataType: 'json',
                success: function(res) {
                    let html = '<option value="" disabled>Select Account</option>';
                    if (Array.isArray(res) && res.length) {
                        res.forEach(acc => {
                            let selected = String(acc.id) === String(alloc.account_id) ? ' selected' : '';
                            html += `<option value="${acc.id}"${selected}>${acc.title}</option>`;
                        });
                    }
                    $accSelect.html(html);
                }
            });
        });
    }

    // 4. Recalculate Totals
    recalcSummary();
    recalcAccountsTotal();

}); // End Document Ready

</script>
@endsection